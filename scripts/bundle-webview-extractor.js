#!/usr/bin/env node
/**
 * Bundles extension-src/webview-content.js (Defuddle + DOMPurify) into a single
 * IIFE string that can be injected into Android's hidden WebView.
 *
 * Output: services/generated/defuddle-webview-bundle.ts
 *
 * Usage:
 *   npm run build:webview-bundle
 *
 * Re-run after updating defuddle or dompurify versions.
 */

const { execSync } = require('child_process');
const fs = require('fs');
const path = require('path');

const ROOT = path.resolve(__dirname, '..');
const ENTRY = path.join(ROOT, 'extension-src', 'webview-content.js');
const OUT_DIR = path.join(ROOT, 'services', 'generated');
const OUT_FILE = path.join(OUT_DIR, 'defuddle-webview-bundle.ts');
const TMP_FILE = path.join(OUT_DIR, '_webview-bundle.tmp.js');

// Ensure output directory exists
if (!fs.existsSync(OUT_DIR)) {
  fs.mkdirSync(OUT_DIR, { recursive: true });
}

console.log('[bundle-webview-extractor] Bundling Defuddle + DOMPurify for WebView injection...');

try {
  // Bundle with esbuild — same approach as withWebExtension.js uses for Safari
  execSync(
    `npx esbuild "${ENTRY}" --bundle --format=iife --global-name=__cpWebViewExtract --outfile="${TMP_FILE}" --minify --target=chrome90`,
    { cwd: ROOT, stdio: 'pipe' }
  );

  const bundleJs = fs.readFileSync(TMP_FILE, 'utf-8');

  // Remove temp file
  fs.unlinkSync(TMP_FILE);

  const bundleSize = Buffer.byteLength(bundleJs, 'utf-8');
  console.log(`[bundle-webview-extractor] Bundle size: ${(bundleSize / 1024).toFixed(1)} KB`);

  // Write as a TypeScript module exporting the bundle string
  const tsContent = [
    '// Auto-generated by scripts/bundle-webview-extractor.js',
    '// Do not edit manually — run `npm run build:webview-bundle` to regenerate.',
    '//',
    '// Contains Defuddle + DOMPurify bundled as a self-executing IIFE for',
    '// injection into Android\'s hidden WebView. See extension-src/webview-content.js',
    '// for the source.',
    '',
    '/* eslint-disable */',
    '',
    `export const DEFUDDLE_EXTRACTION_SCRIPT: string = ${JSON.stringify(bundleJs)};`,
    '',
  ].join('\n');

  fs.writeFileSync(OUT_FILE, tsContent);
  console.log(`[bundle-webview-extractor] Wrote ${OUT_FILE}`);
} catch (err) {
  console.error('[bundle-webview-extractor] Failed to bundle:', err.stderr?.toString() || err.message);
  process.exit(1);
}
